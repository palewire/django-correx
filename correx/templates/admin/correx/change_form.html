<!--
	A slight modification of http://www.djangosnippets.org/snippets/1085/ by adnan 
	and some methods lifted from Steve Michelotti below
	http://geekswithblogs.net/michelotti/archive/2008/06/28/mvc-json---jsonresult-and-jquery.aspx
	
	Since including an app, model or object along with your change is optional,
	the idea is to only show those fields progressively as the user fills out the form.
	First the app, then the model, and then finally the object.
	
	I think the object look up taken from adnan's code works pretty well, but I'd love
	to know a way to be able to filter the model dropdown list based on the app selected.
	
	// ToDo
	* Hide the stupid object_id box. Who needs it?
	* Beef up the object lookup link
	* Come up with some object "clear" button for when you want to delete the object id will editing
	* Consider some slidy jQuery magic on the show and hides.
	* Figure out if I can filter the models.
-->

{% extends "admin/change_form.html" %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script>

	function showObjectLookup() {
		$(".object_id").append("<div id='lookup_box'></div>");
		// Grab the app and model names
		var app = $("#id_content_app option:selected").text();
		var model = $("#id_content_type option:selected").text();
		// Create the link to the object list
		var link_root = '../../../';
		$("#lookup_box").html("<a onclick='return showRelatedObjectLookupPopup(this);' id='lookup_id_object_id' class='related-lookup' href='../../../'>lookup</a>");
		$("#lookup_id_object_id").text("Lookup " + model);
		$("#lookup_id_object_id").attr('href', link_root + app + '/' + model + '/');
	}
	
	function fetch_contenttypes_by_app(selected_app_label) {
		$.getJSON("/correx/admin/filter/contenttype/", { app_label : selected_app_label }, 
			function(data){
				$("#id_content_type").fillSelect(data)
			});
	}
	
	$.fn.clearSelect = function() {
		return this.each(function() {
			if (this.tagName == 'SELECT')
			this.options.length = 0;
		});
	} 

	$.fn.fillSelect = function(data) {
		return this.clearSelect().each(function() {
			if (this.tagName == 'SELECT') {
				var dropdownList = this;
				$.each(data, function(index, optionData) {
					var option = new Option(optionData.Text, optionData.Value);   
					if ($.browser.msie) {
						dropdownList.add(option);
					} else {
						dropdownList.add(option, null);
					}
				});
			}
		});
	}

 $(document).ready(function(){
	
	// Hide the model and ID fields, only showing them once their parent has been selected
	// but it shouldn't hide them if they're already filled and we're editing an existing record.
	if ($("#id_content_type option:selected").val() === '') {
		$(".content_type").hide();
	}
	
	if ($("#id_object_id").val() === '') {
		$(".object_id").hide();
	} else {
		// Show the object selection link
		showObjectLookup();
	}

	// When an app is selected, show the model box.
	// It would be nice if this could filter the model list
	// by app, since many model names are going to recurr
	// and large projects will have a long list of models
	$("#id_content_app").change(function () {
		$("#id_content_type").clearSelect();
		fetch_contenttypes_by_app($("#id_content_app option:selected").val());
		$(".content_type").show();
	});

	// When model is selected...
	$("#id_content_type").change(function () {
		// Unhide the object id box
		$(".object_id").show();
		// Show the object selection link
		showObjectLookup();
	})

 });




</script>

{% endblock %}
